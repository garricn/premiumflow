<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='site.css') }}" />
  </head>
  <body>
    <header>
      <h1>Import {{ import_record.id }}</h1>
      <nav class="top-nav">
        <a href="{{ url_for('imports_history') }}">Back to history</a>
        <a href="{{ url_for('index') }}">Upload CSV</a>
        <a href="{{ url_for('legs_view') }}">Matched legs</a>
        <a href="{{ url_for('cost_basis_view') }}">Cost basis overrides</a>
      </nav>
      <p>Account: {{ account_label }}</p>
    </header>
    <main>
      <section class="import-actions">
        <form
          method="post"
          action="{{ url_for('delete_import', import_id=import_record.id) }}"
          class="action-form"
          onsubmit="return confirm({{ ('Delete import %s for %s? This cannot be undone.' % (import_record.id, account_label)) | tojson }});"
        >
          <input type="hidden" name="page_size" value="{{ default_page_size }}" />
          <button type="submit" class="danger-button">Delete import</button>
        </form>
        <p class="import-actions-note">
          Removing an import deletes all associated transactions. Re-upload the CSV from the Upload
          page if you need to restore it.
        </p>
      </section>
      <section class="import-metadata">
        <dl class="import-summary">
          <div>
            <dt>Imported at</dt>
            <dd>{{ imported_at }}</dd>
          </div>
          <div>
            <dt>Rows</dt>
            <dd>{{ import_record.row_count }}</dd>
          </div>
          <div>
            <dt>Options only</dt>
            {% if has_stock_transactions %}
            <dd>No — stock &amp; transfer rows preserved</dd>
            {% else %}
            <dd>{{ "Yes" if import_record.options_only else "No" }}</dd>
            {% endif %}
          </div>
          <div>
            <dt>Open only</dt>
            <dd>{{ "Yes" if import_record.open_only else "No" }}</dd>
          </div>
          <div>
            <dt>Ticker</dt>
            <dd>{{ import_record.ticker or "—" }}</dd>
          </div>
          <div>
            <dt>Strategy</dt>
            <dd>{{ import_record.strategy or "—" }}</dd>
          </div>
          <div>
            <dt>Activity start</dt>
            <dd>{{ activity_start or "—" }}</dd>
          </div>
          <div>
            <dt>Activity end</dt>
            <dd>{{ activity_end or "—" }}</dd>
          </div>
          <div>
            <dt>Source path</dt>
            <dd>{{ import_record.source_path }}</dd>
          </div>
        </dl>
      </section>
      {% if pending_cost_basis %}
      <section class="cost-basis-summary">
        <h2>Pending transfer cost basis overrides</h2>
        <p>
          These transfer rows still require manual cost basis entries.
          Manage overrides from the <a href="{{ url_for('cost_basis_view') }}">cost basis dashboard</a>.
        </p>
        <table class="data-table">
          <thead>
            <tr>
              <th scope="col">Ticker</th>
              <th scope="col">Shares</th>
              <th scope="col">Activity date</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for item in pending_cost_basis %}
            <tr class="{% if item.id in due_cost_basis_ids %}warning-row{% endif %}">
              <td>{{ item.instrument }}</td>
              <td>{{ item.shares }}</td>
              <td>{{ item.activity_date }}</td>
              <td>
                {% if item.status == "pending" %}
                Pending
                {% else %}
                Snoozed
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      {% endif %}
      {% if resolved_cost_basis %}
      <section class="cost-basis-summary">
        <h2>Resolved transfer cost basis overrides</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th scope="col">Ticker</th>
              <th scope="col">Shares</th>
              <th scope="col">Activity date</th>
              <th scope="col">Total basis</th>
              <th scope="col">Basis per share</th>
            </tr>
          </thead>
          <tbody>
            {% for item in resolved_cost_basis %}
            <tr>
              <td>{{ item.instrument }}</td>
              <td>{{ item.shares }}</td>
              <td>{{ item.activity_date }}</td>
              <td>{{ format_currency(item.basis_total) }}</td>
              <td>{{ format_currency(item.basis_per_share) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      {% endif %}
      <section>
        <h2>Option Transactions</h2>
        <p class="section-note">
          Option rows include contract-specific fields such as strike, expiration, and option type.
        </p>
        {% if transactions %}
        <table class="data-table">
          <thead>
            <tr>
              <th scope="col">Activity date</th>
              <th scope="col">Instrument</th>
              <th scope="col">Action</th>
              <th scope="col">Quantity</th>
              <th scope="col">Price</th>
              <th scope="col">Amount</th>
              <th scope="col">Description</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in transactions %}
            <tr>
              <td>{{ txn.activity_date }}</td>
              <td>{{ txn.instrument }}</td>
              <td>{{ txn.action }} ({{ txn.trans_code }})</td>
              <td>{{ txn.quantity }}</td>
              <td>{{ txn.price }}</td>
              <td>{{ txn.amount or "—" }}</td>
              <td>{{ txn.description }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="empty-state">This import did not persist option transactions.</p>
        {% endif %}
      </section>
      <section>
        <h2>Stock &amp; Transfer Transactions</h2>
        <p class="section-note">
          These rows come from the same CSV export but do not carry option contract details; they capture
          cash and share movements like ACH deposits or ACAT transfers.
        </p>
        {% if stock_transactions %}
        <table class="data-table">
          <thead>
            <tr>
              <th scope="col">Activity date</th>
              <th scope="col">Instrument</th>
              <th scope="col">Action</th>
              <th scope="col">Quantity</th>
              <th scope="col">Price</th>
              <th scope="col">Amount</th>
              <th scope="col">Description</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in stock_transactions %}
            <tr>
              <td>{{ txn.activity_date }}</td>
              <td>{{ txn.instrument }}</td>
              <td>{{ txn.action }} ({{ txn.trans_code }})</td>
              <td>{{ txn.quantity }}</td>
              <td>{{ txn.price }}</td>
              <td>{{ txn.amount }}</td>
              <td>{{ txn.description }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="empty-state">This import did not persist stock or transfer transactions.</p>
        {% endif %}
      </section>
    </main>
  </body>
</html>
